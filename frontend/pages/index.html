<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Tokkatot - ផ្ទះ</title>
  <link rel="icon" href="/assets/images/tokkatot logo-02.png" type="image/x-icon" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    /* Coop selector pill row */
    .coop-pills { display: flex; gap: var(--space-sm); overflow-x: auto; padding: var(--space-sm) var(--space-md); scrollbar-width: none; }
    .coop-pills::-webkit-scrollbar { display: none; }
    .coop-pill { flex-shrink: 0; padding: 10px var(--space-md); border-radius: var(--radius-full); border: 2px solid var(--color-border); font-size: var(--font-size-base); font-weight: 600; background: var(--color-surface); color: var(--color-text-secondary); cursor: pointer; white-space: nowrap; min-height: var(--touch-min); display: flex; align-items: center; }
    .coop-pill.active { border-color: var(--color-primary); background: var(--color-primary); color: #fff; }
    /* Metric cards */
    .metric-card.temp-card { background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); color: #fff; }
    .metric-card.temp-card .metric-label,
    .metric-card.temp-card .metric-unit { color: rgba(255,255,255,0.8); }
    .metric-card.temp-card .metric-value { color: #fff; }
    .metric-card.temp-card .metric-icon { color: rgba(255,255,255,0.9); }
    .metric-card.hum-card { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; }
    .metric-card.hum-card .metric-label,
    .metric-card.hum-card .metric-unit { color: rgba(255,255,255,0.8); }
    .metric-card.hum-card .metric-value { color: #fff; }
    .metric-card.hum-card .metric-icon { color: rgba(255,255,255,0.9); }
    /* Chicken count card */
    .count-card { background: var(--color-secondary-light); border-color: var(--color-secondary); }
    .count-card .metric-icon { color: var(--color-secondary-dark); }
    /* Device grid */
    .devices-grid { display: flex; flex-direction: column; gap: var(--space-sm); padding: 0 var(--space-md) var(--space-md); }
    /* Control button */
    .ctrl-btn { min-width: 80px; min-height: 40px; font-size: var(--font-size-sm); border-radius: var(--radius-full); font-weight: 600; }
    .ctrl-btn.on  { background: var(--color-primary); color: #fff; }
    .ctrl-btn.off { background: var(--color-bg); color: var(--color-text-secondary); border: 2px solid var(--color-border); }
    /* Quick action row */
    .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); padding: 0 var(--space-md) var(--space-md); }
    .quick-btn { display: flex; flex-direction: column; align-items: center; gap: 6px; background: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-md); min-height: 88px; font-size: var(--font-size-sm); font-weight: 600; color: var(--color-text-secondary); box-shadow: var(--shadow-sm); border: 1px solid var(--color-border); cursor: pointer; transition: background 0.15s; }
    .quick-btn .material-symbols-outlined { font-size: 32px; color: var(--color-primary); }
    .quick-btn:active { background: var(--color-primary-light); }
    /* No farm state */
    .setup-card { margin: var(--space-md); padding: var(--space-xl); background: var(--color-surface); border-radius: var(--radius-xl); box-shadow: var(--shadow-md); text-align: center; }
  </style>
</head>
<body>

<div id="header-placeholder"></div>

<div id="app">

  <!-- Loading state -->
  <div v-if="loading" class="loading-spinner">
    <div class="spinner"></div>
    <span data-i18n="loading">កំពុងផ្ទុក...</span>
  </div>

  <!-- No farm setup -->
  <div v-else-if="farms.length === 0" class="setup-card">
    <span class="material-symbols-outlined" style="font-size:64px;color:var(--color-border);">agriculture</span>
    <h2 style="margin-top:var(--space-md);margin-bottom:var(--space-sm);" data-i18n="no_farm">មិនទាន់មានចំការ</h2>
    <p class="color-muted text-sm">Contact your farm owner to get access.</p>
  </div>

  <!-- Dashboard content -->
  <template v-else>

    <!-- Farm selector (if multiple) -->
    <div v-if="farms.length > 1" style="padding: var(--space-sm) var(--space-md) 0;">
      <select class="form-select" v-model="selectedFarmId" @change="onFarmChange">
        <option v-for="f in farms" :key="f.id" :value="f.id">{{ f.name }}</option>
      </select>
    </div>

    <!-- Farm banner -->
    <div class="farm-banner" style="margin: var(--space-sm) var(--space-md); border-radius: var(--radius-lg);">
      <span class="material-symbols-outlined" style="font-size:32px;">agriculture</span>
      <div class="farm-banner-text">
        <div class="farm-banner-name">{{ currentFarm ? currentFarm.name : '...' }}</div>
        <div class="farm-banner-sub">{{ coops.length }} {{ t('coops') }}</div>
      </div>
    </div>

    <!-- Coop selector pills -->
    <div v-if="coops.length > 0" class="coop-pills">
      <button
        v-for="c in coops"
        :key="c.id"
        class="coop-pill"
        :class="{ active: c.id === selectedCoopId }"
        @click="selectCoop(c)"
      >{{ c.name }}</button>
    </div>

    <!-- Environment metrics -->
    <div class="metrics-grid">
      <!-- Temperature -->
      <div class="metric-card temp-card">
        <div class="metric-label" data-i18n="temperature">សីតុណ្ហភាព</div>
        <div style="display:flex;align-items:flex-end;gap:4px;">
          <div class="metric-value">{{ temp !== null ? temp : '--' }}</div>
          <div class="metric-unit" style="margin-bottom:8px;">°C</div>
        </div>
        <span class="metric-icon material-symbols-outlined">thermometer</span>
      </div>

      <!-- Humidity -->
      <div class="metric-card hum-card">
        <div class="metric-label" data-i18n="humidity">សំណើម</div>
        <div style="display:flex;align-items:flex-end;gap:4px;">
          <div class="metric-value">{{ humidity !== null ? humidity : '--' }}</div>
          <div class="metric-unit" style="margin-bottom:8px;">%</div>
        </div>
        <span class="metric-icon material-symbols-outlined">water_drop</span>
      </div>
    </div>

    <!-- Chicken count + last updated -->
    <div class="section" style="padding-top:0;">
      <div style="display:flex;gap:var(--space-md);">
        <div class="metric-card count-card" style="flex:1;">
          <div class="metric-label" data-i18n="chickens">មាន់</div>
          <div style="display:flex;align-items:baseline;gap:6px;">
            <div style="font-size:var(--font-size-2xl);font-weight:700;">{{ coopChickens !== null ? coopChickens : '--' }}</div>
            <div class="metric-unit" v-if="coopCapacity">/ {{ coopCapacity }}</div>
          </div>
        </div>
        <div class="card" style="flex:1;display:flex;flex-direction:column;gap:4px;">
          <div class="text-sm color-muted">{{ t('now') }}</div>
          <div style="font-size:var(--font-size-sm);font-weight:600;">{{ lastUpdated }}</div>
          <div class="badge" :class="wsConnected ? 'badge-success' : 'badge-neutral'" style="align-self:flex-start;margin-top:4px;">
            {{ wsConnected ? t('online') : t('offline') }}
          </div>
        </div>
      </div>
    </div>

    <!-- Quick actions -->
    <div class="section" style="padding-top:0;">
      <div class="section-header">
        <span class="section-title" data-i18n="devices">ឧបករណ៍</span>
        <a href="/schedules" class="section-action" data-i18n="schedules">កាលវិភាគ</a>
      </div>
      <div class="devices-grid" v-if="devices.length > 0">
        <div
          class="device-row"
          v-for="d in devices.slice(0, 6)"
          :key="d.id"
        >
          <div class="list-item-icon">
            <span class="material-symbols-outlined">{{ deviceIcon(d.type) }}</span>
          </div>
          <div class="device-info">
            <div class="device-name">{{ d.name }}</div>
            <div class="device-status" :class="d.status === 'online' ? 'online' : 'offline'">
              {{ d.status === 'online' ? t('online') : t('offline') }}
            </div>
          </div>
          <button
            class="btn ctrl-btn"
            :class="d.last_state === 'on' ? 'on' : 'off'"
            @click="toggleDevice(d)"
            :disabled="d.loading"
          >
            <span v-if="d.loading" class="spinner" style="width:18px;height:18px;border-width:2px;"></span>
            <span v-else>{{ d.last_state === 'on' ? t('turn_off') : t('turn_on') }}</span>
          </button>
        </div>
      </div>
      <div v-else class="empty-state" style="padding:var(--space-lg);">
        <span class="material-symbols-outlined" style="font-size:48px;">devices</span>
        <span class="text-sm color-muted" data-i18n="no_devices">មិនទាន់មានឧបករណ៍</span>
      </div>
    </div>

    <!-- Quick nav shortcuts -->
    <div class="section" style="padding-top:0;">
      <div class="quick-actions">
        <a href="/monitoring" class="quick-btn">
          <span class="material-symbols-outlined">thermostat</span>
          <span data-i18n="monitoring">ការត្រួតពិនិត្យ</span>
        </a>
        <a href="/disease-detection" class="quick-btn">
          <span class="material-symbols-outlined">biotech</span>
          <span data-i18n="disease_detection">ការរកឃើញជំងឺ</span>
        </a>
        <a href="/schedules" class="quick-btn">
          <span class="material-symbols-outlined">schedule</span>
          <span data-i18n="schedules">កាលវិភាគ</span>
        </a>
        <a href="/profile" class="quick-btn">
          <span class="material-symbols-outlined">account_circle</span>
          <span data-i18n="my_profile">គណនីខ្ញុំ</span>
        </a>
      </div>
    </div>

  </template>

</div><!-- #app -->

<div id="navbar-placeholder"></div>

<!-- Scripts -->
<script src="/js/utils/i18n.js"></script>
<script src="/js/utils/api.js"></script>
<script src="/js/utils/components.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      loading:      true,
      farms:        [],
      selectedFarmId: null,
      coops:        [],
      selectedCoopId: null,
      temp:         null,
      humidity:     null,
      coopChickens: null,
      coopCapacity: null,
      devices:      [],
      lastUpdated:  '--',
      wsConnected:  false,
      ws:           null,
    };
  },
  computed: {
    currentFarm() {
      return this.farms.find(f => f.id === this.selectedFarmId) || null;
    }
  },
  async mounted() {
    if (!window.API.requireAuth()) return;
    await loadComponents();
    await this.loadFarms();
  },
  methods: {
    t(k) { return window.i18n ? window.i18n.t(k) : k; },

    async loadFarms() {
      this.loading = true;
      try {
        const data = await window.API.get('/v1/farms');
        this.farms = (data && data.data && data.data.farms) ? data.data.farms : [];
        if (this.farms.length > 0) {
          const saved = window.API.getSelectedFarmId();
          const match = saved && this.farms.find(f => String(f.id) === saved);
          this.selectedFarmId = match ? match.id : this.farms[0].id;
          window.API.setSelectedFarmId(this.selectedFarmId);
          if (this.farms[0] && this.farms[0].name) localStorage.setItem('farm_name', this.farms[0].name);
          await this.loadCoops();
        }
      } catch(e) { console.error(e); }
      finally { this.loading = false; }
    },

    async onFarmChange() {
      window.API.setSelectedFarmId(this.selectedFarmId);
      await this.loadCoops();
    },

    async loadCoops() {
      const fid = this.selectedFarmId;
      if (!fid) return;
      try {
        const data = await window.API.get('/v1/farms/' + fid + '/coops');
        this.coops = (data && data.data && data.data.coops) ? data.data.coops : [];
        if (this.coops.length > 0) {
          const saved = window.API.getSelectedCoopId();
          const match = saved && this.coops.find(c => String(c.id) === saved);
          await this.selectCoop(match || this.coops[0]);
        }
        await this.loadDevices();
      } catch(e) { console.error(e); }
    },

    async selectCoop(coop) {
      this.selectedCoopId = coop.id;
      window.API.setSelectedCoopId(coop.id);
      await this.loadCoopData(coop.id);
      this.connectWS();
    },

    async loadCoopData(coopId) {
      const fid = this.selectedFarmId;
      if (!fid || !coopId) return;
      try {
        const data = await window.API.get('/v1/farms/' + fid + '/coops/' + coopId);
        const c = data && data.data ? data.data : {};
        this.temp         = c.temperature !== undefined ? c.temperature : null;
        this.humidity     = c.humidity    !== undefined ? c.humidity    : null;
        this.coopChickens = c.current_count !== undefined ? c.current_count : null;
        this.coopCapacity = c.capacity     !== undefined ? c.capacity     : null;
        this.lastUpdated  = c.last_updated ? new Date(c.last_updated).toLocaleTimeString() : '--';
      } catch(e) { console.error(e); }
    },

    async loadDevices() {
      const fid = this.selectedFarmId;
      if (!fid) return;
      try {
        const data = await window.API.get('/v1/farms/' + fid + '/devices');
        const raw = (data && data.data && data.data.devices) ? data.data.devices : [];
        this.devices = raw.map(d => ({ ...d, loading: false }));
      } catch(e) { console.error(e); }
    },

    async toggleDevice(device) {
      device.loading = true;
      const cmd = device.last_state === 'on' ? 'turn_off' : 'turn_on';
      try {
        await window.API.post('/v1/devices/' + device.id + '/command', { command_type: cmd });
        device.last_state = device.last_state === 'on' ? 'off' : 'on';
      } catch(e) { console.error(e); }
      finally { device.loading = false; }
    },

    deviceIcon(type) {
      const icons = {
        water_pump: 'water_pump', fan: 'mode_fan', light: 'light_mode',
        feeder: 'restaurant', heater: 'mode_heat', conveyor: 'conveyor_belt',
        sensor: 'sensors', default: 'electrical_services'
      };
      return icons[type] || icons.default;
    },

    connectWS() {
      if (this.ws) { try { this.ws.close(); } catch(_) {} }
      const token  = localStorage.getItem('access_token');
      const fid    = this.selectedFarmId;
      const coopId = this.selectedCoopId;
      if (!token || !fid || !coopId) return;
      try {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        this.ws = new WebSocket(proto + '://' + location.host + '/v1/ws?token=' + token + '&farm_id=' + fid + '&coop_id=' + coopId);
        this.ws.onopen  = () => { this.wsConnected = true; };
        this.ws.onclose = () => { this.wsConnected = false; };
        this.ws.onerror = () => { this.wsConnected = false; };
        this.ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.temperature !== undefined) this.temp     = msg.temperature;
            if (msg.humidity    !== undefined) this.humidity = msg.humidity;
            this.lastUpdated = new Date().toLocaleTimeString();
          } catch(_) {}
        };
      } catch(e) { console.warn('[WS]', e); }
    }
  },

  beforeUnmount() {
    if (this.ws) try { this.ws.close(); } catch(_) {}
  }
}).mount('#app');
</script>
</body>
</html>