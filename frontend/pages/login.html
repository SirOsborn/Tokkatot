<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Tokkatot - ចូលគណនី</title>
  <link rel="icon" href="/assets/images/tokkatot logo-02.png" type="image/x-icon" />
  <!-- Global design system -->
  <link rel="stylesheet" href="/css/style.css" />
  <!-- Google Material Symbols -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    body { padding: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--color-bg); }
    .auth-page { width: 100%; max-width: 400px; padding: var(--space-lg) var(--space-md); }
    .auth-logo { display: flex; flex-direction: column; align-items: center; margin-bottom: var(--space-xl); gap: var(--space-sm); }
    .auth-logo img { width: 80px; height: 80px; object-fit: contain; }
    .auth-logo-name { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-primary); }
    .auth-logo-sub  { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
    .auth-title { font-size: var(--font-size-2xl); font-weight: 700; color: var(--color-text); margin-bottom: var(--space-lg); }
    .auth-footer { text-align: center; margin-top: var(--space-lg); font-size: var(--font-size-base); color: var(--color-text-secondary); }
    .auth-footer a { color: var(--color-primary); font-weight: 600; }
    .lang-row { display: flex; justify-content: flex-end; margin-bottom: var(--space-md); }
    .forms-stack { display: flex; flex-direction: column; gap: var(--space-md); }
  </style>
</head>
<body class="no-nav no-header">

<div id="app" class="auth-page">

  <!-- Language toggle -->
  <div class="lang-row">
    <button class="lang-toggle" @click="toggleLang">{{ lang === 'km' ? 'EN' : 'KM' }}</button>
  </div>

  <!-- Logo -->
  <div class="auth-logo">
    <img src="/assets/images/tokkatot logo-02.png" alt="Tokkatot" />
    <span class="auth-logo-name">Tokkatot</span>
    <span class="auth-logo-sub">{{ t('your_farm') }}</span>
  </div>

  <!-- Title -->
  <h1 class="auth-title">{{ t('login') }}</h1>

  <!-- Error alert -->
  <div v-if="errorMsg" class="alert alert-danger" role="alert">
    <span class="material-symbols-outlined">error</span>
    {{ errorMsg }}
  </div>

  <!-- Login form -->
  <div class="forms-stack">
    <!-- Email -->
    <div class="form-group">
      <label class="form-label" for="email">{{ t('email') }}</label>
      <div class="form-input-icon">
        <span class="input-icon material-symbols-outlined">mail</span>
        <input
          id="email"
          class="form-input"
          type="email"
          v-model="email"
          :placeholder="t('email')"
          autocomplete="email"
          inputmode="email"
          @keyup.enter="doLogin"
          required
        />
      </div>
    </div>

    <!-- Password -->
    <div class="form-group">
      <label class="form-label" for="password">{{ t('password') }}</label>
      <div class="form-input-icon">
        <span class="input-icon material-symbols-outlined">lock</span>
        <input
          id="password"
          class="form-input"
          :type="showPwd ? 'text' : 'password'"
          v-model="password"
          :placeholder="t('password')"
          autocomplete="current-password"
          @keyup.enter="doLogin"
          required
        />
        <span class="input-icon-right material-symbols-outlined" @click="showPwd = !showPwd">
          {{ showPwd ? 'visibility_off' : 'visibility' }}
        </span>
      </div>
    </div>

    <!-- Login button -->
    <button
      class="btn btn-primary btn-full btn-lg"
      @click="doLogin"
      :disabled="loading"
    >
      <span v-if="loading" class="spinner" style="width:24px;height:24px;border-width:3px;"></span>
      <span v-else>{{ t('login') }}</span>
    </button>
  </div>

  <!-- Register link -->
  <p class="auth-footer">
    {{ t('no_account') }}
    <a href="/register">{{ t('register') }}</a>
  </p>

</div>

<!-- Scripts -->
<script src="/js/utils/i18n.js"></script>
<script src="/js/utils/api.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      email:    '',
      password: '',
      showPwd:  false,
      loading:  false,
      errorMsg: '',
      lang: window.i18n ? window.i18n.getLang() : 'km'
    };
  },
  mounted() {
    /* Redirect if already logged in */
    if (window.API && window.API.isAuthenticated()) {
      window.location.href = '/';
    }
  },
  methods: {
    t(key) {
      return window.i18n ? window.i18n.t(key) : key;
    },
    toggleLang() {
      if (window.i18n) {
        window.i18n.toggleLang();
        this.lang = window.i18n.getLang();
        document.documentElement.lang = this.lang;
      }
    },
    async doLogin() {
      this.errorMsg = '';
      if (!this.email || !this.password) {
        this.errorMsg = this.lang === 'km'
          ? 'សូមបំពេញអ៊ីមែល និង លេខសម្ងាត់'
          : 'Please enter email and password.';
        return;
      }
      this.loading = true;
      try {
        const data = await window.API.post('/v1/auth/login', {
          email:    this.email,
          password: this.password
        });
        if (data && data.success && data.data) {
          localStorage.setItem('access_token',  data.data.access_token);
          localStorage.setItem('refresh_token', data.data.refresh_token);
          if (data.data.user && data.data.user.name) {
            localStorage.setItem('user_name', data.data.user.name);
          }
          window.location.href = '/';
        } else {
          this.errorMsg = (data && data.message) || this.t('login_failed');
        }
      } catch (e) {
        this.errorMsg = this.t('login_failed');
      } finally {
        this.loading = false;
      }
    }
  }
}).mount('#app');
</script>
</body>
</html>
