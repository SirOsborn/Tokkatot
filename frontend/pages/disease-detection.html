<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI រកជំងឺ - Tokkatot</title>
    <link rel="icon" href="/assets/images/tokkatot logo-02.png" type="image/x-icon" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body {
            background: var(--color-bg);
        }
        .upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-xl) var(--space-lg);
            text-align: center;
            cursor: pointer;
            background: var(--color-surface);
            transition: border-color 0.2s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }
        .upload-icon { font-size: 56px; color: var(--color-primary); opacity: 0.5; }
        .preview-img { width: 100%; max-height: 280px; object-fit: cover; border-radius: var(--radius-lg); margin: var(--space-md) 0; display: none; }
        .result-card { display: none; }
        .confidence-bar-wrap { background: var(--color-border); border-radius: 99px; height: 10px; margin: var(--space-sm) 0; overflow: hidden; }
        .confidence-bar-fill { height: 100%; background: var(--color-primary); border-radius: 99px; transition: width 0.5s; }
        .healthy-badge   { color: #16a34a; background: #dcfce7; }
        .disease-badge   { color: #dc2626; background: #fee2e2; }
    </style>
</head>
<body>

<!-- =====================================================
     COMING SOON OVERLAY — remove this div when AI is live
     ===================================================== -->
<div id="coming-soon-overlay" style="
    position: fixed; inset: 0; z-index: 9999;
    background: var(--color-bg, #f4f6f8);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 40px 32px; text-align: center;
">
    <span class="material-symbols-outlined" style="font-size:72px;color:var(--color-primary,#20a39e);margin-bottom:16px;">science</span>
    <h1 style="color:var(--color-text,#1a1a1a);font-size:24px;margin:0 0 8px;font-weight:800;">AI រកជំងឺមាន់</h1>
    <p style="color:var(--color-text-secondary,#6b7280);font-size:18px;margin:0 0 4px;">AI Disease Detection</p>
    <div style="
        background: var(--color-primary,#20a39e); color: #fff;
        font-size: 11px; font-weight: 700; letter-spacing: 2px;
        padding: 4px 14px; border-radius: 20px;
        margin: 16px 0 24px; text-transform: uppercase;
    ">Coming Soon</div>
    <p style="color:var(--color-text-secondary,#6b7280);font-size:16px;max-width:300px;line-height:1.7;margin:0 0 40px;">
        យើងកំពុងបណ្ដុះបណ្ដាល AI ដើម្បីរកជំងឺ​មាន់​ពីរូប​ភាព​។
        មុខ​ងារ​នេះ​នឹង​អាច​ប្រើ​បាន​ក្នុង​កំណែ​បន្ទាប់​។
    </p>
    <a href="/" style="text-decoration:none;">
        <button class="btn btn-primary" style="min-width:180px;font-size:16px;">
            <span class="material-symbols-outlined">arrow_back</span>
            ទៅ​ទំព័រ​ដើម
        </button>
    </a>
</div>
<!-- END COMING SOON OVERLAY -->

<div id="header-placeholder"></div>

<div id="app">
    <div class="page-title" data-i18n="disease">រក​ជំងឺ​មាន់</div>

    <!-- Upload zone -->
    <div class="section" style="padding-top:0;">
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">
                <span class="material-symbols-outlined" style="font-size:56px;">photo_camera</span>
            </div>
            <p style="font-size:var(--font-size-lg);font-weight:700;margin:var(--space-sm) 0;">
                ថតរូប ឬ​ជ្រើស​រូបភាព
            </p>
            <p class="color-muted text-sm">ដ្រាប់រូបភាព ឬ​ចុចដើម្បីជ្រើស</p>
            <div style="display:flex;gap:var(--space-md);justify-content:center;margin-top:var(--space-md);">
                <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()">
                    <span class="material-symbols-outlined">photo_camera</span>
                    ថតរូប
                </button>
                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
                    <span class="material-symbols-outlined">upload</span>
                    ជ្រើស​ឯកសារ
                </button>
            </div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
            <input type="file" id="fileInput" accept="image/*" style="display:none;">
        </div>

        <img id="previewImg" class="preview-img" alt="Preview" />

        <!-- Loading -->
        <div id="loadingState" style="display:none;text-align:center;padding:var(--space-xl);">
            <div class="spinner" style="margin:0 auto var(--space-md);"></div>
            <p style="font-size:var(--font-size-lg);">កំពុង​វិភាគ​រូបភាព​ដោយ AI…</p>
        </div>

        <!-- Result -->
        <div id="resultCard" class="card result-card" style="margin-top:var(--space-md);">
            <div class="card-body">
                <div id="resultBadge" class="badge" style="font-size:var(--font-size-base);padding:8px 16px;margin-bottom:var(--space-md);"></div>
                <div style="font-size:var(--font-size-sm);color:var(--color-text-secondary);margin-bottom:4px;">
                    កម្រិត​ជឿ​ជាក់
                </div>
                <div class="confidence-bar-wrap">
                    <div id="confBar" class="confidence-bar-fill" style="width:0%"></div>
                </div>
                <div id="confText" style="font-size:var(--font-size-sm);color:var(--color-text-secondary);margin-bottom:var(--space-md);"></div>
                <div style="font-weight:700;margin-bottom:var(--space-sm);">ការ​ណែ​នាំ</div>
                <div id="recommendation" style="font-size:var(--font-size-base);line-height:1.7;color:var(--color-text-secondary);"></div>
                <button class="btn btn-ghost w-full" style="margin-top:var(--space-md);" onclick="resetDetection()">
                    <span class="material-symbols-outlined">refresh</span>
                    សាកល្បង​ម្ដង​ទៀត
                </button>
            </div>
        </div>
    </div>
</div>

<div id="navbar-placeholder"></div>

<script src="/js/utils/i18n.js"></script>
<script src="/js/utils/api.js"></script>
<script src="/js/utils/components.js"></script>
<script>
    async function init() {
        if (!window.API.requireAuth()) return;
        await loadComponents();
    }

    // ── File inputs ───────────────────────────────────────────────────────────
    document.getElementById('cameraInput').addEventListener('change', e => handleFile(e.target.files[0]));
    document.getElementById('fileInput').addEventListener('change', e => handleFile(e.target.files[0]));

    // ── Drag & drop ───────────────────────────────────────────────────────────
    const zone = document.getElementById('uploadZone');
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('dragover');
        if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) return;
        if (file.size > 10 * 1024 * 1024) { alert('ឯកសារ​ត្រូវ​តែ​តិច​ជាង 10MB'); return; }
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.getElementById('previewImg');
            img.src = e.target.result;
            img.style.display = 'block';
        };
        reader.readAsDataURL(file);
        uploadAndAnalyze(file);
    }

    async function uploadAndAnalyze(file) {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('resultCard').style.display = 'none';
        try {
            const formData = new FormData();
            formData.append('image', file);
            const token = localStorage.getItem('access_token');
            const res = await fetch('/v1/ai/predict-disease', {
                method: 'POST',
                headers: { Authorization: 'Bearer ' + token },
                body: formData
            });
            const result = await res.json();
            document.getElementById('loadingState').style.display = 'none';
            if (result.success) showResult(result.prediction);
            else showResult(null, result.message || 'ការ​វិភាគ​បរាជ័យ');
        } catch(e) {
            document.getElementById('loadingState').style.display = 'none';
            showResult(null, 'បញ្ហា​បណ្ដាញ: ' + e.message);
        }
    }

    function showResult(pred, error) {
        const card    = document.getElementById('resultCard');
        const badge   = document.getElementById('resultBadge');
        const confBar = document.getElementById('confBar');
        const confTxt = document.getElementById('confText');
        const rec     = document.getElementById('recommendation');

        card.style.display = 'block';
        if (error || !pred) {
            badge.textContent = '❌ ការ​វិភាគ​បរាជ័យ';
            badge.className = 'badge disease-badge';
            confBar.style.width = '0%';
            confTxt.textContent = '';
            rec.textContent = error || 'Unknown error';
            return;
        }
        const pct = Math.round(pred.confidence * 100);
        if (pred.is_healthy) {
            badge.textContent = '✅ ' + pred.predicted_disease;
            badge.className = 'badge healthy-badge';
        } else {
            badge.textContent = '⚠️ រក​ឃើញ​ជំងឺ: ' + pred.predicted_disease;
            badge.className = 'badge disease-badge';
        }
        confBar.style.width = pct + '%';
        confTxt.textContent = pct + '% ជឿ​ជាក់';
        rec.textContent = pred.recommendation || '';
    }

    function resetDetection() {
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('previewImg').src = '';
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('cameraInput').value = '';
        document.getElementById('fileInput').value = '';
    }

    init().catch(console.error);
</script>
</body>
</html>
